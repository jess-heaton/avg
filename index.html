/* Hide other elements when chat is active */
        .main-container.chat-active .hero-section,
        .main-container.chat-active .prompt-examples {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s ease;
        }    <div class="bg-particles"></div><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stannp - Natural Language Postal Services</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #162988;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(22, 41, 136, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            height: 32px;
        }

        .logo img {
            height: 32px;
            width: auto;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.2s ease;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: #ffffff;
        }

        /* Main content */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            z-index: 10;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #ffffff;
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }

        /* Chat interface */
        .chat-interface {
            width: 100%;
            max-width: 700px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 2rem;
            margin-bottom: 3rem;
            animation: fadeInUp 0.6s ease-out 0.1s both;
            transition: all 0.4s ease;
        }

        .chat-interface.active {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            max-width: none;
            width: 100%;
            margin: 0;
            border-radius: 0;
            border: none;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            background: #162988;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: none;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        .chat-interface.active .chat-messages {
            display: block;
        }

        .message {
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.4s ease-out;
            max-width: 100%;
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message.bot {
            display: flex;
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            font-size: 1rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: #ffffff;
            color: #162988;
            border-radius: 18px 18px 4px 18px;
        }

        .message.bot .message-bubble {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border-radius: 18px 18px 18px 4px;
        }

        .input-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .chat-interface.active .input-container {
            margin-bottom: 0;
            padding: 1.5rem 2rem 2rem;
            max-width: 800px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }

        .chat-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem 3.5rem 1rem 1rem;
            color: #ffffff;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
            resize: none;
            min-height: 60px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .chat-input:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #ffffff;
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #162988;
        }

        .send-button:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .chat-header {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: #162988;
        }

        .chat-interface.active .chat-header {
            display: flex;
        }

        .chat-title {
            display: flex;
            align-items: center;
            height: 28px;
        }

        .chat-title img {
            height: 28px;
            width: auto;
        }

        /* API Setup Modal */
        .api-setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: #ffffff;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            margin: 0 0 0.5rem 0;
            color: #162988;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-content p {
            margin: 0 0 1.5rem 0;
            color: #666;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #162988;
            box-shadow: 0 0 0 3px rgba(22, 41, 136, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 0.5rem;
            color: #999;
            font-size: 0.85rem;
        }

        .form-group small a {
            color: #162988;
            text-decoration: none;
        }

        .form-group small a:hover {
            text-decoration: underline;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-primary,
        .btn-secondary {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: #162988;
            color: white;
        }

        .btn-primary:hover {
            background: #0f1f66;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* API Status Indicator */
        .api-status {
            position: fixed;
            top: 80px;
            right: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            z-index: 100;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .api-status:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .api-status.connected {
            border-color: #4ade80;
            color: #4ade80;
        }

        .api-status.disconnected {
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chat-messages {
                padding: 1rem;
            }
            
            .chat-interface.active .input-container {
                padding: 1rem;
            }
            
            .message-bubble {
                max-width: 85%;
                font-size: 0.95rem;
            }
        }

        /* Prompt examples */
        .prompt-examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 700px;
            animation: fadeInUp 1s ease-out 0.4s both;
        }

        .example-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .example-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .example-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .example-text {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            font-size: 0.95rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
            border-top: 1px solid rgba(22, 41, 136, 0.2);
            backdrop-filter: blur(10px);
            background: rgba(15, 17, 38, 0.8);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .nav-links {
                display: none;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .chat-interface {
                padding: 1.5rem;
            }
            
            .prompt-examples {
                grid-template-columns: 1fr;
            }
        }

        /* Floating elements animation */
        .floating-element {
            position: absolute;
            opacity: 0.1;
            animation: floating 6s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <div class="bg-particles"></div>
    
    <!-- API Status Indicator -->
    <div class="api-status disconnected" onclick="showApiSetup()">
        <span id="api-status-text">⚡ Connect Stannp Account</span>
    </div>

    <header class="header">
        <a href="#" class="logo">
            <img src="https://www.stannp.com/website-2022/assets/images/stannp_logo.svg" alt="Stannp" />
        </a>
        <nav class="nav-links">
            <a href="#">Features</a>
            <a href="#">Pricing</a>
            <a href="#">API</a>
            <a href="#">Support</a>
        </nav>
    </header>

    <main class="main-container">
        <section class="hero-section">
            <h1 class="hero-title">Postal Services,<br>Naturally Spoken</h1>
            <p class="hero-subtitle">
                Transform the way you send mail with natural language commands. 
                Just describe what you want to send, and we'll handle the rest with intelligent automation.
            </p>
        </section>

        <div class="chat-interface">
            <div class="chat-header">
                <div class="chat-title">
                    <img src="https://www.stannp.com/website-2022/assets/images/stannp_logo.svg" alt="Stannp" />
                </div>
            </div>
            <div class="chat-messages"></div>
            <div class="input-container">
                <textarea 
                    class="chat-input" 
                    placeholder="Try: 'Send 1000 postcards to customers in London with our summer promotion'"
                    rows="3"
                ></textarea>
                <button class="send-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <section class="prompt-examples">
            <div class="example-card">
                <div class="example-title">Bulk Mailings</div>
                <div class="example-text">
                    "Send personalized letters to our top 500 customers thanking them for their loyalty"
                </div>
            </div>
            
            <div class="example-card">
                <div class="example-title">Targeted Campaigns</div>
                <div class="example-text">
                    "Mail flyers about our new restaurant to everyone within 2 miles of our location"
                </div>
            </div>
            
            <div class="example-card">
                <div class="example-title">Event Invitations</div>
                <div class="example-text">
                    "Create and send elegant wedding invitations to my guest list for June 15th"
                </div>
            </div>
            
            <div class="example-card">
                <div class="example-title">Direct Mail</div>
                <div class="example-text">
                    "Send product catalogs to potential customers in Manchester and Birmingham"
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Stannp. Revolutionizing postal services with natural language.</p>
    </footer>

    <script>
        // Voiceflow API Configuration
        const VOICEFLOW_API_KEY = 'VF.DM.687f54fa0bf027f087d40b7c.3may6qf1h20Pa6Q2';
        const VOICEFLOW_VERSION_ID = 'development'; // or 'production'
        
        // Generate a unique user ID for this session
        const USER_ID = 'user_' + Math.random().toString(36).substring(2, 15);
        
        // Track conversation state and Stannp integration
        let conversationStarted = false;
        let isProcessing = false;
        let chatActive = false;
        let stannpApiKey = null;
        let stannpApiRegion = 'eu1'; // Default to EU

        // Stannp API Integration
        const STANNP_ENDPOINTS = {
            eu1: 'https://api-eu1.stannp.com/v1',
            us1: 'https://api-us1.stannp.com/v1'
        };

        // Available Stannp API functions based on research
        const STANNP_FUNCTIONS = {
            // User & Account
            getUserInfo: () => ({ endpoint: '/user/info', method: 'GET', description: 'Get account information' }),
            
            // Recipients Management
            createRecipient: () => ({ 
                endpoint: '/recipients/new', 
                method: 'POST', 
                description: 'Add a new recipient to mailing list',
                params: ['firstname', 'lastname', 'address1', 'city', 'postcode', 'country', 'group_id']
            }),
            listRecipients: () => ({ 
                endpoint: '/recipients/list', 
                method: 'GET', 
                description: 'List all recipients or filter by group'
            }),
            deleteRecipient: () => ({ 
                endpoint: '/recipients/delete', 
                method: 'POST', 
                description: 'Delete a recipient from account'
            }),
            
            // Groups Management  
            listGroups: () => ({ 
                endpoint: '/groups/list', 
                method: 'GET', 
                description: 'List all mailing groups'
            }),
            createGroup: () => ({ 
                endpoint: '/groups/new', 
                method: 'POST', 
                description: 'Create a new mailing group'
            }),
            
            // Postcards
            sendPostcard: () => ({ 
                endpoint: '/postcards/create', 
                method: 'POST', 
                description: 'Send a postcard with PDF design',
                params: ['pdf', 'recipient', 'test', 'size']
            }),
            
            // Letters
            sendLetter: () => ({ 
                endpoint: '/letters/create', 
                method: 'POST', 
                description: 'Send a letter with PDF content',
                params: ['pdf', 'recipient', 'test', 'duplex', 'size']
            }),
            
            // Reporting
            getReportingSummary: () => ({ 
                endpoint: '/reporting/summary/:startdate/:enddate', 
                method: 'GET', 
                description: 'Get delivery status summary for date range'
            }),
            getReportingList: () => ({ 
                endpoint: '/reporting/list/:startdate/:enddate/:status', 
                method: 'GET', 
                description: 'Get detailed list of sent mail pieces'
            })
        };

        // Make Stannp API call
        async function callStannpAPI(endpoint, method = 'GET', data = null) {
            if (!stannpApiKey) {
                throw new Error('Stannp API key not configured. Please enter your API key first.');
            }

            const baseUrl = STANNP_ENDPOINTS[stannpApiRegion];
            const url = `${baseUrl}${endpoint}`;
            
            const options = {
                method: method,
                headers: {
                    'Authorization': `Basic ${btoa(stannpApiKey + ':')}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            };

            if (method === 'POST' && data) {
                const formData = new URLSearchParams();
                Object.keys(data).forEach(key => {
                    formData.append(key, data[key]);
                });
                options.body = formData;
            } else if (method === 'GET' && data) {
                const params = new URLSearchParams(data);
                url += `?${params}`;
            }

            try {
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || `HTTP error! status: ${response.status}`);
                }
                
                return result;
            } catch (error) {
                console.error('Stannp API Error:', error);
                throw error;
            }
        }

        // Show API key setup modal
        function showApiSetup() {
            const modal = document.createElement('div');
            modal.className = 'api-setup-modal';
            modal.innerHTML = `
                <div class="modal-backdrop"></div>
                <div class="modal-content">
                    <h3>Connect Your Stannp Account</h3>
                    <p>Enter your Stannp API key to enable account actions like sending postcards, managing recipients, and viewing reports.</p>
                    
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="stannp-api-key" placeholder="Your Stannp API key" />
                        <small>Find your API key in your <a href="https://app-eu1.stannp.com/settings" target="_blank">Stannp settings</a></small>
                    </div>
                    
                    <div class="form-group">
                        <label>Region</label>
                        <select id="stannp-region">
                            <option value="eu1">Europe (api-eu1.stannp.com)</option>
                            <option value="us1">US (api-us1.stannp.com)</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn-secondary" onclick="closeApiSetup()">Cancel</button>
                        <button class="btn-primary" onclick="saveApiKey()">Connect Account</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Close API setup modal
        function closeApiSetup() {
            const modal = document.querySelector('.api-setup-modal');
            if (modal) modal.remove();
        }

        // Save API key
        async function saveApiKey() {
            const apiKeyInput = document.getElementById('stannp-api-key');
            const regionSelect = document.getElementById('stannp-region');
            
            const apiKey = apiKeyInput.value.trim();
            const region = regionSelect.value;
            
            if (!apiKey) {
                alert('Please enter your Stannp API key');
                return;
            }
            
            // Test the API key
            try {
                stannpApiKey = apiKey;
                stannpApiRegion = region;
                
                // Test connection
                await callStannpAPI('/user/info');
                
                closeApiSetup();
                updateApiStatus(true);
                
                if (chatActive) {
                    addMessage('✅ Stannp account connected successfully! I can now help you send mail, manage recipients, and view reports.', false);
                }
                
            } catch (error) {
                stannpApiKey = null;
                updateApiStatus(false);
                alert('Failed to connect: ' + error.message + '\nPlease check your API key and try again.');
            }
        }

        // Process natural language for Stannp actions
        async function processStannpAction(message, intent) {
            try {
                switch (intent) {
                    case 'send_postcard':
                        return await handleSendPostcard(message);
                    case 'send_letter':
                        return await handleSendLetter(message);
                    case 'list_recipients':
                        return await handleListRecipients(message);
                    case 'add_recipient':
                        return await handleAddRecipient(message);
                    case 'get_reports':
                        return await handleGetReports(message);
                    case 'list_groups':
                        return await handleListGroups(message);
                    default:
                        return 'I can help you with: sending postcards/letters, managing recipients, viewing reports, and managing mailing groups. What would you like to do?';
                }
            } catch (error) {
                if (error.message.includes('API key not configured')) {
                    showApiSetup();
                    return 'To perform account actions, I need to connect to your Stannp account. Please enter your API key in the popup.';
                }
                return `Error: ${error.message}`;
            }
        }

        // Handle different Stannp actions (simplified examples)
        async function handleSendPostcard(message) {
            // This would need more sophisticated NLP to extract recipient details
            return 'To send a postcard, I need: recipient details (name, address) and your postcard design (PDF). Would you like me to guide you through creating one?';
        }

        async function handleListRecipients(message) {
            const result = await callStannpAPI('/recipients/list');
            const count = result.data?.length || 0;
            return `You have ${count} recipients in your account. Would you like me to show details for any specific group?`;
        }

        async function handleGetReports(message) {
            // Extract date range from message or use default
            const today = new Date().toISOString().split('T')[0];
            const lastWeek = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            const result = await callStannpAPI(`/reporting/summary/${lastWeek}/${today}`);
            const data = result.data;
            
            return `📊 Mail Summary (Last 7 days):
• Total sent: ${data.total || 0}
• Delivered: ${data.delivered || 0}  
• In transit: ${data.local_delivery || 0}
• Returned: ${data.returned || 0}`;
        }

        async function handleListGroups(message) {
            const result = await callStannpAPI('/groups/list');
            const groups = result.data || [];
            
            if (groups.length === 0) {
                return 'You don\'t have any mailing groups yet. Would you like me to help create one?';
            }
            
            const groupList = groups.map(g => `• ${g.name} (${g.recipients} recipients)`).join('\n');
            return `📋 Your Mailing Groups:\n${groupList}`;
        }

        async function handleAddRecipient(message) {
            return 'To add a recipient, I need their details: name, address, city, postcode, and country. You can also specify which mailing group to add them to. Please provide these details.';
        }

        // Transform to chat interface
        function activateChat() {
            if (chatActive) return;
            
            chatActive = true;
            const chatInterface = document.querySelector('.chat-interface');
            const mainContainer = document.querySelector('.main-container');
            
            // Add class to main container to hide other elements
            mainContainer.classList.add('chat-active');
            
            // Transform chat interface to fullscreen
            setTimeout(() => {
                chatInterface.classList.add('active');
                
                // Update placeholder
                const chatInput = document.querySelector('.chat-input');
                chatInput.placeholder = "Type your message...";
                chatInput.focus();
            }, 300);
        }

        // Add message to chat
        function addMessage(message, isUser = false) {
            const chatMessages = document.querySelector('.chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = message;
            
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Animated background particles
        function createParticles() {
            const container = document.querySelector('.bg-particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.width = particle.style.height = Math.random() * 4 + 2 + 'px';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(particle);
            }
        }

        // Voiceflow API interaction
        async function interactWithVoiceflow(request) {
            const url = `https://general-runtime.voiceflow.com/state/user/${USER_ID}/interact`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': VOICEFLOW_API_KEY,
                        'Content-Type': 'application/json',
                        'versionID': VOICEFLOW_VERSION_ID
                    },
                    body: JSON.stringify({ request })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Voiceflow API Error:', error);
                return [{
                    type: 'speak',
                    payload: {
                        type: 'message',
                        message: 'Sorry, I\'m having trouble connecting. Please try again.'
                    }
                }];
            }
        }

        // Start conversation with Voiceflow
        async function startConversation() {
            if (!conversationStarted) {
                conversationStarted = true;
                const traces = await interactWithVoiceflow({ type: 'launch' });
                processResponse(traces);
            }
        }

        // Send user message to Voiceflow
        async function sendMessage(message) {
            if (isProcessing) return;
            
            isProcessing = true;
            showTyping();
            
            // If conversation hasn't started, start it first
            if (!conversationStarted) {
                await startConversation();
                // Small delay to let initial response process
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const traces = await interactWithVoiceflow({ 
                type: 'text', 
                payload: message 
            });
            
            hideTyping();
            processResponse(traces);
            isProcessing = false;
        }

        // Process Voiceflow response traces and check for Stannp actions
        function processResponse(traces) {
            let responseMessage = '';
            let hasStannpAction = false;
            
            traces.forEach(trace => {
                switch (trace.type) {
                    case 'speak':
                        if (trace.payload?.message) {
                            responseMessage += trace.payload.message + ' ';
                        }
                        break;
                    case 'text':
                        if (trace.payload?.message) {
                            responseMessage += trace.payload.message + ' ';
                        }
                        break;
                    case 'stannp_action':
                        // Custom trace type for Stannp actions
                        hasStannpAction = true;
                        handleStannpTrace(trace.payload);
                        break;
                    default:
                        break;
                }
            });

            if (responseMessage.trim()) {
                // Check if response indicates a Stannp action intent
                const message = responseMessage.trim();
                const stannpKeywords = ['send postcard', 'send letter', 'recipients', 'mailing list', 'reports', 'groups', 'mail'];
                const hasStannpKeyword = stannpKeywords.some(keyword => 
                    message.toLowerCase().includes(keyword.toLowerCase())
                );

                if (hasStannpKeyword && !hasStannpAction) {
                    // Try to handle as Stannp action
                    handlePotentialStannpAction(message);
                }

                if (chatActive) {
                    addMessage(message, false);
                } else {
                    displayResponse(message);
                }
            }
        }

        // Handle potential Stannp actions
        async function handlePotentialStannpAction(message) {
            const lowerMessage = message.toLowerCase();
            
            let intent = null;
            if (lowerMessage.includes('send postcard') || lowerMessage.includes('postcard')) {
                intent = 'send_postcard';
            } else if (lowerMessage.includes('send letter') || lowerMessage.includes('letter')) {
                intent = 'send_letter';
            } else if (lowerMessage.includes('recipients') || lowerMessage.includes('mailing list')) {
                intent = 'list_recipients';
            } else if (lowerMessage.includes('reports') || lowerMessage.includes('summary')) {
                intent = 'get_reports';
            } else if (lowerMessage.includes('groups')) {
                intent = 'list_groups';
            }

            if (intent) {
                try {
                    const result = await processStannpAction(message, intent);
                    setTimeout(() => {
                        if (chatActive) {
                            addMessage(result, false);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Stannp action error:', error);
                }
            }
        }

        // Handle Stannp-specific traces
        function handleStannpTrace(payload) {
            // This would handle custom Stannp actions from Voiceflow
            console.log('Stannp action:', payload);
        }

        // Update API status indicator
        function updateApiStatus(connected = false) {
            const statusElement = document.querySelector('.api-status');
            const textElement = document.getElementById('api-status-text');
            
            if (connected) {
                statusElement.className = 'api-status connected';
                textElement.textContent = '✅ Stannp Connected';
            } else {
                statusElement.className = 'api-status disconnected';  
                textElement.textContent = '⚡ Connect Stannp Account';
            }
        }

        // Display response in landing mode (before chat activation)
        function displayResponse(message) {
            // Immediately activate chat and add the first bot message
            activateChat();
            
            // Wait for chat to be fully active, then add message
            setTimeout(() => {
                addMessage(message, false);
            }, 400);
        }

        // Show typing indicator
        function showTyping() {
            const sendButton = document.querySelector('.send-button');
            sendButton.style.background = '#6b7280';
            sendButton.innerHTML = `
                <div style="display: flex; gap: 2px;">
                    <div style="width: 4px; height: 4px; border-radius: 50%; background: white; animation: typing 1.4s infinite ease-in-out;"></div>
                    <div style="width: 4px; height: 4px; border-radius: 50%; background: white; animation: typing 1.4s infinite ease-in-out 0.2s;"></div>
                    <div style="width: 4px; height: 4px; border-radius: 50%; background: white; animation: typing 1.4s infinite ease-in-out 0.4s;"></div>
                </div>
            `;
        }

        // Hide typing indicator
        function hideTyping() {
            const sendButton = document.querySelector('.send-button');
            sendButton.style.background = '#ffffff';
            sendButton.style.color = '#162988';
            sendButton.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
        }

        // Input interactions
        const chatInput = document.querySelector('.chat-input');
        const sendButton = document.querySelector('.send-button');
        const examples = document.querySelectorAll('.example-card');

        examples.forEach(example => {
            example.addEventListener('click', () => {
                const text = example.querySelector('.example-text').textContent;
                chatInput.value = text;
                chatInput.focus();
            });
        });

        sendButton.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (message && !isProcessing) {
                // Add user message to chat if in chat mode
                if (chatActive) {
                    addMessage(message, true);
                }
                
                chatInput.value = '';
                chatInput.style.height = '60px'; // Reset height
                await sendMessage(message);
            }
        });

        chatInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                sendButton.click();
            }
        });

        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Floating animation for input focus
        chatInput.addEventListener('focus', () => {
            chatInput.parentElement.style.transform = 'translateY(-1px)';
        });

        chatInput.addEventListener('blur', () => {
            chatInput.parentElement.style.transform = 'translateY(0)';
        });

        // Add typing animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes typing {
                0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
                40% { transform: scale(1.2); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
